name: AI Documentation Sync

on:
  schedule:
    # Run every day at 9:00 UTC
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write # Needed for creating PRs

jobs:
  ai-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 50 # Get recent history for analysis
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main # Always start from main branch

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install OpenAI SDK (for OpenRouter)
        run: pnpm add openai glob

      - name: Sync with latest main
        run: |
          git fetch origin main
          git reset --hard origin/main
          echo "âœ“ Synced with latest main branch"

      - name: Run AI Documentation Sync
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: node scripts/ai-sync-docs.js

      - name: Check for changes
        id: verify-changes
        run: |
          if git diff --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "## No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "Documentation is already up to date!" >> $GITHUB_STEP_SUMMARY
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create Pull Request
        if: steps.verify-changes.outputs.changed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: AI-powered documentation sync

            ğŸ¤– Generated by Claude AI based on recent commits and code changes.

            Updates include:
            - CHANGELOG.md: Recent changes documented
            - ROADMAP.md: Progress tracking and completed items
            - CLAUDE.md: Tech stack version sync
            - Documentation pages: Updated based on code changes
          branch: docs/ai-sync-${{ github.run_number }}
          base: main # Ensure PR targets main branch
          delete-branch: true
          title: "ğŸ¤– AI Documentation Sync - ${{ github.run_number }}"
          body: |
            ## ğŸ¤– Automated Documentation Update

            This PR was automatically generated by **Claude AI** (claude-sonnet-4-5) analyzing the last 7 days of activity.

            ### ğŸ“‹ What Was Updated

            - âœ… **CHANGELOG.md** - Added entries for recent changes
            - âœ… **ROADMAP.md** - Updated progress and moved completed items
            - âœ… **CLAUDE.md** - Synced tech stack versions from package.json
            - âœ… **Documentation Pages** - Updated relevant docs based on code changes

            ### ğŸ” Analysis Period

            - **Commits analyzed:** Last 7 days
            - **Branch base:** Synced with `main` at workflow start
            - **Workflow run:** [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Generated:** ${{ github.event.repository.updated_at }}

            ### ğŸ“ Review Checklist

            - [ ] Changelog entries accurately reflect recent changes
            - [ ] Roadmap progress matches actual development status
            - [ ] CLAUDE.md tech stack is current and correct
            - [ ] Documentation updates are accurate and helpful
            - [ ] Code examples compile and follow project conventions
            - [ ] Mermaid diagrams render correctly

            ### ğŸš€ How This Works

            This automation uses the **docs-writer agent** approach:
            1. Syncs with latest `main` branch
            2. Analyzes git commits and file changes
            3. Uses Claude AI to understand the context
            4. Generates intelligent documentation updates
            5. Creates this PR for human review (never commits directly)

            ---

            *Generated with Claude AI via `scripts/ai-sync-docs.js`*
            *Review the docs-writer agent: `.claude/agents/docs-writer.md`*
          labels: |
            documentation
            automated
            ai-generated
          assignees: drifter089

      - name: PR Created Successfully
        if: steps.verify-changes.outputs.changed == 'true' && steps.create-pr.outputs.pull-request-number
        run: |
          echo "âœ… Pull Request #${{ steps.create-pr.outputs.pull-request-number }} created successfully"
          echo "ğŸ”— URL: ${{ steps.create-pr.outputs.pull-request-url }}"
          echo "ğŸ“Š View at: ${{ steps.create-pr.outputs.pull-request-url }}"

      - name: Summary
        run: |
          if [ "${{ steps.verify-changes.outputs.changed }}" == "true" ]; then
            echo "âœ… Documentation updates prepared and PR created"
            echo "ğŸ”— Review PR: ${{ steps.create-pr.outputs.pull-request-url }}"
          else
            echo "âœ… No changes needed - documentation is up to date"
          fi

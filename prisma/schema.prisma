// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")

}

// Metric System Enums
enum MetricType {
    PERCENTAGE
    NUMBER
    DURATION
    RATE
}

enum CollectionFrequency {
    REAL_TIME
    DAILY
    WEEKLY
    MONTHLY
    QUARTERLY
}

model Post {
    id        Int      @id @default(autoincrement())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([name])
}

model Task {
    id          String   @id @default(cuid())
    title       String
    description String?
    completed   Boolean  @default(false)
    priority    Int      @default(0)
    userId      String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@index([userId])
    @@index([completed])
}

// Team Management System Models

model Team {
    id             String   @id @default(cuid())
    name           String
    description    String?
    organizationId String   // WorkOS organization ID
    createdBy      String   // WorkOS user ID

    // Store React Flow state as JSON
    reactFlowNodes Json     @default("[]") // Array of RF nodes with positions
    reactFlowEdges Json     @default("[]") // Array of RF edges
    viewport       Json?    // { x, y, zoom } for canvas position

    roles          Role[]

    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([organizationId])
    @@index([createdBy])
}

model Role {
    id             String   @id @default(cuid())
    teamId         String

    // Role properties (user-defined)
    title          String
    purpose        String   @db.Text
    metricId       String   // References Metric (one-to-one from Role perspective)
    metricGoal     Float?   // Role-specific target (overrides metric's default targetValue)

    // Optional assignment
    assignedUserId String?  // WorkOS user ID

    // Visual properties (synced with React Flow node)
    nodeId         String   // React Flow node ID (for syncing)
    color          String   @default("#3b82f6") // Hex color

    team           Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
    metric         Metric   @relation(fields: [metricId], references: [id])

    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([teamId])
    @@index([metricId])
    @@index([assignedUserId])
}

model Metric {
    id             String              @id @default(cuid())
    name           String              // e.g., "Customer Satisfaction", "Response Time"
    description    String?
    organizationId String?             // WorkOS organization ID - metrics are org-scoped (optional for migration)

    // KPI properties
    type           String              // Legacy string type for migration compatibility
    targetValue    Float?              // Default/suggested target threshold
    currentValue   Float?              // Current value (computed from latest MetricValue)
    unit           String?             // "ms", "%", "requests", etc.

    // Collection metadata
    category       String?             // e.g., "user_signups", "error_tracking", "performance"
    collectionFrequency CollectionFrequency @default(DAILY) // How often data is collected
    dataSource     String?             // Future: "posthog", "sentry", "manual", etc.

    // Mock data generation
    mockDataPrompt String?             @db.Text // AI prompt for generating mock data

    roles          Role[]              // One metric can be used by many roles
    values         MetricValue[]       // Time-series historical data

    createdAt      DateTime            @default(now())
    updatedAt      DateTime            @updatedAt

    @@index([name])
    @@index([organizationId])
    @@index([category])
}

// Time-series data points for metrics
model MetricValue {
    id        String   @id @default(cuid())
    metricId  String
    value     Float    // The actual metric value at this point in time
    timestamp DateTime @default(now()) // When this value was recorded
    metadata  Json?    // Optional: additional context (source, tags, etc.)

    metric    Metric   @relation(fields: [metricId], references: [id], onDelete: Cascade)

    createdAt DateTime @default(now())

    @@index([metricId])
    @@index([timestamp])
    @@index([metricId, timestamp]) // Composite index for time-series queries
}
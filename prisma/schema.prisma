// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    directUrl = env("DIRECT_URL")

}

model Post {
    id        Int      @id @default(autoincrement())
    name      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([name])
}

model Task {
    id          String   @id @default(cuid())
    title       String
    description String?
    completed   Boolean  @default(false)
    priority    Int      @default(0)
    userId      String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@index([userId])
    @@index([completed])
}

// Team Management System Models

model Team {
    id             String   @id @default(cuid())
    name           String
    description    String?
    organizationId String   // WorkOS organization ID
    createdBy      String   // WorkOS user ID

    // Store React Flow state as JSON
    reactFlowNodes Json     @default("[]") // Array of RF nodes with positions
    reactFlowEdges Json     @default("[]") // Array of RF edges
    viewport       Json?    // { x, y, zoom } for canvas position

    roles          Role[]

    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([organizationId])
    @@index([createdBy])
}

model Role {
    id             String   @id @default(cuid())
    teamId         String

    // Role properties (user-defined)
    title          String
    purpose        String   @db.Text
    metricId       String?  // Optional metric reference

    // Optional assignment
    assignedUserId String?  // WorkOS user ID

    // Visual properties (synced with React Flow node)
    nodeId         String   // React Flow node ID (for syncing)
    color          String   @default("#3b82f6") // Hex color

    team           Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
    metric         Metric?  @relation(fields: [metricId], references: [id])

    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([teamId])
    @@index([metricId])
    @@index([assignedUserId])
}

model Metric {
    id             String   @id @default(cuid())
    name           String   // e.g., "Customer Satisfaction", "Response Time"
    description    String?
    organizationId String   // WorkOS organization ID

    // KPI properties
    type           String   // "percentage", "number", "duration", "rate"
    targetValue    Float?   // Target threshold
    currentValue   Float?   // Current value (synced from Nango or mock data)
    unit           String?  // "ms", "%", "requests", etc.

    // Data source
    source         String   @default("manual") // "nango", "custom", "manual"

    // Mock data generation (for metrics not connected to integrations)
    mockDataPrompt String?  @db.Text // AI prompt for generating mock data

    roles              Role[]   // One metric can be used by many roles
    integrationMetrics IntegrationMetric[] // Links to integration sources
    snapshots          MetricSnapshot[] // Time-series history

    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([organizationId])
    @@index([name])
    @@index([source])
}

// Integration Connections (Nango & Custom)

model Integration {
    id             String   @id @default(cuid())

    // Integration type
    type           String   @default("nango") // "nango", "custom"

    // Nango connection identifiers (for type="nango")
    connectionId   String   @unique // UUID from Nango (required for API calls)
    integrationId  String   // Provider name: 'posthog', 'google-sheet', 'custom', etc.

    // Ownership (organization-level connections)
    organizationId String   // WorkOS organization ID
    connectedBy    String   // WorkOS user ID who authorized the connection

    // Connection state
    status         String   @default("active") // "active", "revoked", "error", "expired"

    // Provider-specific data
    metadata       Json?    // Scopes, token expiry, provider user info, etc.

    // Custom integration configuration (for type="custom")
    customConfig   Json?    // URL, auth method, polling interval, etc.

    // Audit trail
    lastSyncAt     DateTime? // Last successful API call
    errorMessage   String?   // Last error if status = "error"

    integrationMetrics IntegrationMetric[] // Metrics created from this integration

    createdAt      DateTime @default(now())
    updatedAt      DateTime @updatedAt

    @@index([organizationId])
    @@index([connectionId])
    @@index([connectedBy])
    @@index([integrationId])
    @@index([status])
    @@index([type])
}

// Junction table linking Integrations to Metrics with configuration
model IntegrationMetric {
    id              String   @id @default(cuid())

    // Link to integration and metric
    integrationId   String
    metricId        String

    // Source configuration (what to track)
    sourceType      String   // "event", "sheet"
    sourceId        String   // Event name, Sheet ID
    sourceConfig    Json?    // Project ID, filters, etc.

    // Staleness detection
    status          String   @default("active") // "active", "stale", "deleted", "error"
    lastValidatedAt DateTime? // Last time we verified source still exists
    errorMessage    String?  // Why it's stale/errored

    // Sync metadata
    nangoModel      String   // "PostHogEvent", "GoogleSheetRow"
    lastSyncedAt    DateTime? // When Nango last synced this data

    integration     Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
    metric          Metric      @relation(fields: [metricId], references: [id], onDelete: Cascade)

    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    @@index([integrationId])
    @@index([metricId])
    @@index([status])
}

// Time-series snapshots for metrics
model MetricSnapshot {
    id         String   @id @default(cuid())
    metricId   String
    value      Float
    timestamp  DateTime @default(now())

    // Metadata about the snapshot
    sourceType String?  // "nango_sync", "manual", "custom"
    metadata   Json?    // Sync details, record counts, etc.

    metric     Metric   @relation(fields: [metricId], references: [id], onDelete: Cascade)

    createdAt  DateTime @default(now())

    @@index([metricId, timestamp])
    @@index([timestamp])
}